#!/usr/bin/env node

const { Pool } = require('pg');
const { DomainHelper } = require('../src/lib/domain-helper.js');
const { TenantValidation } = require('../src/lib/tenant-validation.js');

const pool = new Pool({
  connectionString: process.env.DATABASE_URL || 'postgresql://postgres:Delus9798-@localhost:5432/protege',
});

async function testDomainStructure() {
  const client = await pool.connect();

  try {
    console.log('üèóÔ∏è Testando Estrutura Completa de Dom√≠nios\n');

    // 1. Verificar configura√ß√£o de dom√≠nios
    console.log('1Ô∏è‚É£ Verificando dom√≠nios configurados...\n');

    const domains = await client.query(`
      SELECT
        dp.dominio,
        dp.tipo,
        dp.verificado,
        dp.ativo,
        p.nome_empresa,
        p.tenant_id
      FROM dominios_personalizados dp
      LEFT JOIN provedores p ON dp.provedor_id = p.id
      WHERE dp.ativo = true
      ORDER BY
        CASE
          WHEN dp.dominio LIKE 'admin.%' THEN 1
          ELSE 2
        END,
        dp.dominio
    `);

    console.log('üìã Dom√≠nios ativos no sistema:');
    domains.rows.forEach(domain => {
      const status = domain.verificado ? '‚úÖ' : '‚ö†Ô∏è';
      const type = domain.dominio.includes('admin') ? 'üîê ADMIN' : 'üè¢ PROVEDOR';
      console.log(`   ${status} ${type} ${domain.dominio} - ${domain.nome_empresa || 'Sistema'}`);
    });

    // 2. Testar detec√ß√£o de dom√≠nios
    console.log('\n2Ô∏è‚É£ Testando detec√ß√£o de dom√≠nios...\n');

    const testDomains = [
      'admin.localhost',
      'admin.localhost:3000',
      'admin.parceirize.com.br',
      'empresa1.localhost',
      'empresa2.localhost',
      'clube.localhost',
      'localhost:3000'
    ];

    for (const testDomain of testDomains) {
      try {
        const result = await DomainHelper.detectTenantByDomain(testDomain);

        if (result) {
          const icon = result.isSuperadmin ? 'üîê' : 'üè¢';
          console.log(`   ${icon} ${testDomain}:`);
          console.log(`      ‚îú‚îÄ Tipo: ${result.tipo}`);
          console.log(`      ‚îú‚îÄ Empresa: ${result.nome_empresa}`);
          console.log(`      ‚îú‚îÄ Verificado: ${result.verificado ? 'Sim' : 'N√£o'}`);
          console.log(`      ‚îî‚îÄ Superadmin: ${result.isSuperadmin ? 'Sim' : 'N√£o'}`);
        } else {
          console.log(`   üåê ${testDomain}: Dom√≠nio principal (sem tenant)`);
        }
      } catch (error) {
        console.log(`   ‚ùå ${testDomain}: Erro - ${error.message}`);
      }
      console.log('');
    }

    // 3. Testar isolamento de usu√°rios
    console.log('3Ô∏è‚É£ Testando isolamento de usu√°rios...\n');

    const users = await client.query(`
      SELECT
        'cliente' as user_type,
        id, nome, email, tenant_id, 'cliente' as role
      FROM clientes WHERE ativo = true
      UNION ALL
      SELECT
        'parceiro' as user_type,
        id, nome_empresa as nome, email, tenant_id, 'parceiro' as role
      FROM parceiros WHERE ativo = true
      UNION ALL
      SELECT
        'provedor' as user_type,
        id, nome_empresa as nome, email, tenant_id, 'provedor' as role
      FROM provedores WHERE ativo = true
      UNION ALL
      SELECT
        'superadmin' as user_type,
        id, nome, email, NULL as tenant_id, 'superadmin' as role
      FROM superadmins WHERE ativo = true
      ORDER BY user_type, email
    `);

    const testCases = [
      {
        name: 'Superadmin em dom√≠nio admin',
        domain: 'admin.localhost',
        user: users.rows.find(u => u.role === 'superadmin'),
        shouldAllow: true,
        expectedReason: 'superadmin_domain_access'
      },
      {
        name: 'Cliente em dom√≠nio admin (deve bloquear)',
        domain: 'admin.localhost',
        user: users.rows.find(u => u.role === 'cliente'),
        shouldAllow: false,
        expectedReason: 'admin_domain_restricted'
      },
      {
        name: 'Cliente correto no dom√≠nio do provedor',
        domain: 'empresa1.localhost',
        user: users.rows.find(u => u.role === 'cliente' && u.email === 'cliente1@teste.com'),
        shouldAllow: true,
        expectedReason: 'tenant_match'
      },
      {
        name: 'Cliente de empresa1 tentando empresa2 (deve bloquear)',
        domain: 'empresa2.localhost',
        user: users.rows.find(u => u.role === 'cliente' && u.email === 'cliente1@teste.com'),
        shouldAllow: false,
        expectedReason: 'tenant_mismatch'
      },
      {
        name: 'Superadmin acessando qualquer provedor',
        domain: 'empresa1.localhost',
        user: users.rows.find(u => u.role === 'superadmin'),
        shouldAllow: true,
        expectedReason: 'superadmin_access'
      }
    ];

    for (const testCase of testCases) {
      if (!testCase.user) {
        console.log(`   ‚ö†Ô∏è  ${testCase.name} - Usu√°rio n√£o encontrado`);
        continue;
      }

      console.log(`   üß™ ${testCase.name}`);
      console.log(`      Usu√°rio: ${testCase.user.email} (${testCase.user.role})`);
      console.log(`      Dom√≠nio: ${testCase.domain}`);

      try {
        const result = await TenantValidation.validateUserDomainAccess(testCase.domain, testCase.user);

        const success = result.allowed === testCase.shouldAllow;
        const icon = success ? '‚úÖ' : '‚ùå';
        const expected = testCase.shouldAllow ? 'PERMITIR' : 'BLOQUEAR';
        const actual = result.allowed ? 'PERMITIDO' : 'BLOQUEADO';

        console.log(`      ${icon} Esperado: ${expected} | Resultado: ${actual}`);
        console.log(`      üìù Motivo: ${result.reason}`);

        if (result.message) {
          console.log(`      üí¨ Mensagem: ${result.message}`);
        }

        if (!success) {
          console.log(`      ‚ö†Ô∏è  TESTE FALHOU!`);
        }

      } catch (error) {
        console.log(`      ‚ùå Erro no teste: ${error.message}`);
      }

      console.log('');
    }

    // 4. Testar estrutura de rotas
    console.log('4Ô∏è‚É£ Testando estrutura de rotas...\n');

    const routeTests = [
      {
        description: 'Superadmin em admin.localhost',
        domain: 'admin.localhost',
        path: '/auth/login-admin',
        expectedRedirect: null,
        userRole: 'superadmin'
      },
      {
        description: 'Cliente tentando admin.localhost',
        domain: 'admin.localhost',
        path: '/auth/login',
        expectedRedirect: '/not-authorized',
        userRole: 'cliente'
      },
      {
        description: 'Provedor em empresa1.localhost/admin/login',
        domain: 'empresa1.localhost',
        path: '/admin/login',
        expectedRedirect: null,
        userRole: 'provedor'
      },
      {
        description: 'Parceiro em empresa1.localhost/parceiro/login',
        domain: 'empresa1.localhost',
        path: '/parceiro/login',
        expectedRedirect: null,
        userRole: 'parceiro'
      },
      {
        description: 'Cliente em empresa1.localhost/login',
        domain: 'empresa1.localhost',
        path: '/login',
        expectedRedirect: null,
        userRole: 'cliente'
      }
    ];

    console.log('üìã Rotas de acesso organizadas:');
    routeTests.forEach(test => {
      const icon = test.expectedRedirect ? '‚ùå' : '‚úÖ';
      console.log(`   ${icon} ${test.description}`);
      console.log(`      URL: http://${test.domain}:3000${test.path}`);
      console.log(`      Role: ${test.userRole}`);
      if (test.expectedRedirect) {
        console.log(`      Redirecionamento: ${test.expectedRedirect}`);
      }
      console.log('');
    });

    // 5. Verificar fun√ß√£o do banco
    console.log('5Ô∏è‚É£ Verificando fun√ß√£o do banco...\n');

    const functionTest = await client.query(`
      SELECT routine_name, routine_type
      FROM information_schema.routines
      WHERE routine_name = 'buscar_provedor_por_dominio'
    `);

    if (functionTest.rows.length > 0) {
      console.log('   ‚úÖ Fun√ß√£o buscar_provedor_por_dominio existe');

      // Testar a fun√ß√£o
      try {
        const funcResult = await client.query('SELECT * FROM buscar_provedor_por_dominio($1)', ['admin.localhost']);
        if (funcResult.rows.length > 0) {
          const result = funcResult.rows[0];
          console.log('   ‚úÖ Fun√ß√£o retorna dados para admin.localhost');
          console.log(`      Superadmin: ${result.issuperadmin}`);
          console.log(`      Nome: ${result.nome_empresa}`);
        } else {
          console.log('   ‚ùå Fun√ß√£o n√£o retorna dados para admin.localhost');
        }
      } catch (error) {
        console.log(`   ‚ùå Erro ao testar fun√ß√£o: ${error.message}`);
      }
    } else {
      console.log('   ‚ùå Fun√ß√£o buscar_provedor_por_dominio n√£o encontrada');
    }

    // 6. Estat√≠sticas finais
    console.log('\n6Ô∏è‚É£ Estat√≠sticas do sistema...\n');

    const stats = await client.query(`
      SELECT
        COUNT(CASE WHEN dp.dominio LIKE 'admin.%' THEN 1 END) as dominios_admin,
        COUNT(CASE WHEN dp.dominio NOT LIKE 'admin.%' THEN 1 END) as dominios_provedores,
        COUNT(DISTINCT p.tenant_id) as tenants_unicos,
        (SELECT COUNT(*) FROM superadmins WHERE ativo = true) as superadmins_ativos,
        (SELECT COUNT(*) FROM provedores WHERE ativo = true) as provedores_ativos,
        (SELECT COUNT(*) FROM parceiros WHERE ativo = true) as parceiros_ativos,
        (SELECT COUNT(*) FROM clientes WHERE ativo = true) as clientes_ativos
      FROM dominios_personalizados dp
      LEFT JOIN provedores p ON dp.provedor_id = p.id
      WHERE dp.ativo = true
    `);

    const stat = stats.rows[0];
    console.log('üìä Resumo do sistema:');
    console.log(`   üîê Dom√≠nios Admin: ${stat.dominios_admin}`);
    console.log(`   üè¢ Dom√≠nios Provedores: ${stat.dominios_provedores}`);
    console.log(`   üÜî Tenants √∫nicos: ${stat.tenants_unicos}`);
    console.log(`   üëë Superadmins: ${stat.superadmins_ativos}`);
    console.log(`   üè™ Provedores: ${stat.provedores_ativos}`);
    console.log(`   ü§ù Parceiros: ${stat.parceiros_ativos}`);
    console.log(`   üë• Clientes: ${stat.clientes_ativos}`);

    console.log('\nüéâ Teste da estrutura de dom√≠nios conclu√≠do!\n');

    console.log('üìã Resumo da Implementa√ß√£o:');
    console.log('   ‚úÖ Dom√≠nio de superadmin isolado (admin.localhost)');
    console.log('   ‚úÖ Rotas organizadas por tipo de usu√°rio');
    console.log('   ‚úÖ Isolamento completo entre tenants');
    console.log('   ‚úÖ Valida√ß√£o no login e middleware');
    console.log('   ‚úÖ Fun√ß√£o de banco atualizada');
    console.log('   ‚úÖ Redirecionamentos inteligentes');

    console.log('\nüß™ Para testar manualmente:');
    console.log('   1. Copie hosts-example.txt para o arquivo hosts do sistema');
    console.log('   2. npm run dev');
    console.log('   3. Teste URLs:');
    console.log('      ‚Ä¢ http://admin.localhost:3000/auth/login-admin (superadmin)');
    console.log('      ‚Ä¢ http://empresa1.localhost:3000/admin/login (provedor)');
    console.log('      ‚Ä¢ http://empresa1.localhost:3000/parceiro/login (parceiro)');
    console.log('      ‚Ä¢ http://empresa1.localhost:3000/login (cliente)');

  } catch (error) {
    console.error('‚ùå Erro no teste da estrutura:', error);
    process.exit(1);
  } finally {
    client.release();
    await pool.end();
  }
}

// Executar se chamado diretamente
if (require.main === module) {
  testDomainStructure().catch(console.error);
}

module.exports = { testDomainStructure };